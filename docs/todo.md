# 顔パーツ操作Webアプリ 開発TODOリスト

## 📋 プロジェクト概要
- **目的**: 顔の特徴点を検出し、顔パーツ（目・口・鼻）をワーピングで操作するWebアプリ
- **技術スタック**: React + TypeScript + Vite + face-api.js + fabric.js
- **対象パーツ**: 目（左右個別）・口・鼻
- **操作方法**: リアルタイムプレビュー、スライダー+数値入力

## 🚀 Phase 1: プロジェクト基盤構築 ✅ **完了**

### 1.1 環境セットアップ
- [x] Vite + React + TypeScript プロジェクト作成
- [x] 必要なライブラリのインストール
  - [x] `@mui/material @emotion/react @emotion/styled` (UI)
  - [x] `face-api.js` (顔検出)
  - [x] `fabric` (画像操作)
  - [x] `zustand` (状態管理)
  - [x] `@types/fabric` (TypeScript型定義)
- [x] プロジェクト構造の作成
  - [x] `src/components/` (React コンポーネント)
  - [x] `src/hooks/` (カスタムフック)
  - [x] `src/utils/` (ユーティリティ関数)
  - [x] `src/types/` (TypeScript型定義)
  - [x] `src/stores/` (状態管理)
  - [x] `public/models/` (face-api.js モデルファイル)

### 1.2 基本コンポーネント作成
- [x] メインレイアウトコンポーネント (`MainLayout.tsx`)
  - [x] 横並びレイアウト（画像エリア｜制御パネル）
- [x] 画像アップロードコンポーネント (`ImageUpload.tsx`)
  - [x] ドラッグ&ドロップ対応
  - [x] ファイル形式検証 (JPG/PNG)
  - [x] ファイルサイズ検証 (8MB以下)
  - [x] 解像度検証 (1920px以下)
- [x] 画像プレビューコンポーネント (`ImagePreview.tsx`)
  - [x] 左右比較表示 (元画像｜編集後)
  - [x] Canvas要素の配置

## 🎯 Phase 2: 顔検出機能実装 ✅ **完了**

### 2.1 face-api.js セットアップ
- [x] face-api.js モデルファイルの配置
  - [x] `tiny_face_detector_model` (軽量顔検出)
  - [x] `face_landmark_68_model` (68個特徴点)
- [x] 顔検出サービス作成 (`faceDetection.ts`)
  - [x] モデル読み込み処理
  - [x] 顔検出処理
  - [x] 68個特徴点の取得
  - [x] エラーハンドリング
- [x] 顔検出フック作成 (`useFaceDetection.ts`)
  - [x] 検出状態管理
  - [x] 特徴点データの保存

### 2.2 特徴点データ構造定義
- [x] TypeScript型定義 (`types/face.ts`)

## 🎨 Phase 3: UI制御パネル実装 ✅ **完了**

### 3.1 制御パネルコンポーネント
- [x] メインパネル (`ControlPanel.tsx`)
  - [x] タブ構成 (目・口・鼻)
  - [x] Material-UI Tabs使用
- [x] 目制御タブ (`EyeControls.tsx`)
  - [x] 左目制御セクション
    - [x] 大きさスライダー (0.5-2.0, step: 0.05)
    - [x] X位置スライダー (-20 to +20)
    - [x] Y位置スライダー (-20 to +20)
    - [x] 各パラメータの数値入力
    - [x] 個別リセットボタン
  - [x] 右目制御セクション（同様）
- [x] 口制御タブ (`MouthControls.tsx`)
  - [x] 幅スライダー (0.5-2.0, step: 0.05)
  - [x] 高さスライダー (0.5-2.0, step: 0.05)
  - [x] X位置スライダー (-30 to +30)
  - [x] Y位置スライダー (-30 to +30)
  - [x] 数値入力 + 個別リセット
- [x] 鼻制御タブ (`NoseControls.tsx`)
  - [x] 幅スライダー (0.7-1.5, step: 0.05)
  - [x] 高さスライダー (0.7-1.5, step: 0.05)
  - [x] X位置スライダー (-15 to +15)
  - [x] Y位置スライダー (-15 to +15)
  - [x] 数値入力 + 個別リセット

### 3.2 パラメータ制御システム
- [x] 状態管理ストア (`stores/faceStore.ts`)
  - [x] 顔パラメータの管理
  - [x] リアルタイム更新処理
  - [x] 個別リセット機能

## 🎨 Phase 3.5: デザイン改善 ✅ **完了 (2025-07-03)**

### 3.5.1 Canvas表示サイズ統一
- [x] `canvasManager.ts` の修正
  - [x] 動的サイズ対応の追加 (`initialize` メソッドにサイズパラメータ)
  - [x] `updateCanvasSize` メソッドの実装
  - [x] 固定サイズ（800x600）から動的サイズへ変更
- [x] `ImagePreview.tsx` の修正
  - [x] Canvas初期化を `canvasSize` 確定後に実行
  - [x] 元画像と編集後画像のサイズ統一
  - [x] 表示領域の一貫性確保
- [x] `useImageWarping.ts` の修正
  - [x] `initializeCanvas` メソッドにサイズパラメータ追加
  - [x] サイズ情報のログ出力追加

### 3.5.2 UI/UX改善
- [x] 元画像と編集後画像の表示サイズ統一
- [x] レスポンシブデザインの改善
- [x] Canvas表示の一貫性確保

## 🖼️ Phase 4: 画像ワーピング実装 ❌ **未実装**

### 4.1 fabric.js セットアップ
- [x] Canvas初期化処理 (`features/image-warping/canvasManager.ts`)
  - [x] fabric.Canvas 作成
  - [x] 画像読み込み処理
  - [x] Canvas サイズ調整（動的サイズ対応済み）
- [ ] 基本画像操作の完成
  - [x] 画像のCanvas配置
  - [x] 画像の中央配置
  - [x] アスペクト比保持
  - [ ] 実際の画像変形処理（未実装）

### 4.2 ワーピング処理（未実装）
- [ ] 目のワーピング (`features/image-warping/warpingUtils.ts`)
  - [ ] 基本スケール変形処理
  - [ ] 位置移動処理
  - [ ] 左右個別処理
- [ ] 口のワーピング
  - [ ] 幅・高さ変形処理
  - [ ] 位置移動処理
- [ ] 鼻のワーピング
  - [ ] 幅・高さ変形処理
  - [ ] 位置移動処理

### 4.3 リアルタイムプレビュー
- [ ] プレビュー更新システム (`hooks/useImageWarping.ts`)
  - [ ] パラメータ変更時の自動更新
  - [ ] Canvas更新の管理
  - [x] エラーハンドリング

## 📁 補助作業: プロジェクト整理 ✅ **完了**

### フォルダー構成整理
- [x] 新しいディレクトリ構造作成
  - [x] `src/components/layout/` - レイアウトコンポーネント
  - [x] `src/components/ui/` - 再利用可能UIコンポーネント
  - [x] `src/components/panels/` - 制御パネル
  - [x] `src/features/` - 機能別モジュール
  - [x] `src/styles/` - CSS統合
- [x] 全インポート文の更新
- [x] ドキュメント更新 (`CLAUDE.md`)

## 🎯 **現在の状況 (2025-07-03)**

### ✅ 完了済み機能
- **基本的な顔パーツ操作アプリの基盤**が実装完了
- 画像アップロード → 顔検出 → UI制御パネル → Canvas表示統一
- Phase 1-3 + Phase 3.5（デザイン改善）が完了済み
- **重要**: 実際の画像ワーピング機能は未実装

### 📱 動作確認
- 開発サーバー: http://localhost:5174/
- ビルド: ✅ 成功
- Canvas表示サイズ: ✅ 統一完了
- リント: ⚠️ 軽微な警告のみ

## 🚀 今後の改善項目 (Phase 5+)

### 💾 Phase 5: 画像保存機能
- [ ] 保存オプション選択
  - [ ] 形式選択 (PNG/JPG)
  - [ ] 品質設定表示
  - [ ] ファイル名設定
- [ ] 画像エクスポート (`features/image-export/`)
  - [ ] Canvas to Blob変換
  - [ ] ファイル形式変換
  - [ ] ダウンロード処理

### 🛠️ Phase 6: エラーハンドリング・最適化
- [ ] パフォーマンス最適化
  - [ ] 大きな画像の自動リサイズ
  - [ ] 処理済みキャッシュ
  - [ ] メモリ使用量の最適化
- [ ] 高度なワーピング処理
  - [ ] より精密な顔パーツ変形アルゴリズム
  - [ ] 自然な変形処理

### 🎨 Phase 7: UI/UX改善
- [ ] ユーザビリティ向上
  - [ ] 初回利用ガイド
  - [ ] サンプル画像の提供
  - [ ] 操作手順の案内
- [ ] 追加機能
  - [ ] プリセット機能
  - [ ] 編集履歴機能

## 📊 全体進捗: **80% 完了**
- **Phase 1-3**: 100% 完了 ✅
- **Phase 3.5**: 100% 完了 ✅（デザイン改善）
- **Phase 4**: 0% 完了 ❌（画像ワーピング機能・最重要）
- **Phase 5+**: 改善・拡張機能（オプション）

## 🖼️ Phase 4: 画像ワーピング実装

### 4.1 fabric.js セットアップ
- [ ] Canvas初期化処理 (`canvas/canvasSetup.ts`)
  - [ ] fabric.Canvas 作成
  - [ ] 画像読み込み処理
  - [ ] Canvas サイズ調整
- [ ] 基本画像操作 (`canvas/imageOperations.ts`)
  - [ ] 画像のCanvas配置
  - [ ] 画像の中央配置
  - [ ] アスペクト比保持

### 4.2 ワーピング処理（Phase 1: 基本変形）
- [ ] 目のワーピング (`warping/eyeWarping.ts`)
  - [ ] 特徴点からの領域抽出
  - [ ] スケール変形処理
  - [ ] 位置移動処理
  - [ ] 左右個別処理
- [ ] 口のワーピング (`warping/mouthWarping.ts`)
  - [ ] 特徴点からの領域抽出
  - [ ] 幅・高さ変形処理
  - [ ] 位置移動処理
- [ ] 鼻のワーピング (`warping/noseWarping.ts`)
  - [ ] 特徴点からの領域抽出
  - [ ] 幅・高さ変形処理
  - [ ] 位置移動処理

### 4.3 リアルタイムプレビュー
- [ ] プレビュー更新システム (`preview/previewSystem.ts`)
  - [ ] パラメータ変更時の自動更新
  - [ ] 変形処理の最適化
  - [ ] レンダリング性能向上
- [ ] プレビューフック (`usePreview.ts`)
  - [ ] 変形処理の実行
  - [ ] Canvas更新の管理
  - [ ] エラーハンドリング

## 💾 Phase 5: 画像保存機能

### 5.1 保存機能実装
- [ ] 保存オプション選択 (`SaveOptions.tsx`)
  - [ ] 形式選択 (オリジナル/PNG/JPG)
  - [ ] 品質設定表示（JPGの場合）
  - [ ] ファイル名設定
- [ ] 画像エクスポート (`export/imageExport.ts`)
  - [ ] Canvas to Blob変換
  - [ ] ファイル形式変換
  - [ ] ダウンロード処理
- [ ] 保存ボタン (`SaveButton.tsx`)
  - [ ] 保存処理の実行
  - [ ] プログレス表示
  - [ ] 成功/失敗メッセージ

## 🛠️ Phase 6: エラーハンドリング・最適化

### 6.1 エラーハンドリング
- [ ] 画像アップロードエラー
  - [ ] 形式不正エラー
  - [ ] サイズ超過エラー
  - [ ] 解像度超過エラー
- [ ] 顔検出エラー
  - [ ] 顔が検出されない場合
  - [ ] 複数の顔が検出された場合
  - [ ] 特徴点取得失敗
- [ ] 処理エラー
  - [ ] ワーピング処理エラー
  - [ ] Canvas操作エラー
  - [ ] 保存処理エラー

### 6.2 パフォーマンス最適化
- [ ] 画像処理の最適化
  - [ ] 大きな画像の自動リサイズ
  - [ ] 処理済みキャッシュ
  - [ ] メモリ使用量の最適化
- [ ] UIの最適化
  - [ ] スライダー操作の遅延処理
  - [ ] 不要な再レンダリング防止
  - [ ] ローディング状態の改善

## 🎨 Phase 7: UI/UX改善

### 7.1 ユーザビリティ向上
- [ ] 初回利用ガイド
  - [ ] 使い方の説明
  - [ ] サンプル画像の提供
  - [ ] 操作手順の案内
- [ ] 視覚的フィードバック
  - [ ] 処理中インジケーター
  - [ ] 成功/失敗メッセージ
  - [ ] 特徴点の視覚化（オプション）

### 7.2 レスポンシブデザイン
- [ ] PC表示の最適化
  - [ ] 各画面サイズでの表示確認
  - [ ] 制御パネルの幅調整
  - [ ] 画像表示の最適化

## 🧪 Phase 8: テスト・検証

### 8.1 機能テスト
- [ ] 各パーツの変形テスト
- [ ] 境界値テスト（最小・最大値）
- [ ] エラーケーステスト
- [ ] 保存機能テスト

### 8.2 パフォーマンステスト
- [ ] 大きな画像での処理速度
- [ ] メモリ使用量の確認
- [ ] 複数操作時の安定性

## 📚 Phase 9: ドキュメント・完成

### 9.1 ドキュメント作成
- [ ] README.md作成
- [ ] API仕様書
- [ ] 操作マニュアル

### 9.2 最終調整
- [ ] 全体的な動作確認
- [ ] バグ修正
- [ ] UI調整

## 🔮 Phase 10: 将来の拡張機能（オプション）

### 10.1 高度な機能
- [ ] 眉毛の調整
- [ ] 輪郭の調整
- [ ] 目の角度調整
- [ ] 口角の調整

### 10.2 追加機能
- [ ] プリセット機能
- [ ] 編集履歴機能
- [ ] 複数顔対応
- [ ] 動画対応

---

## 📊 優先度と所要時間見積もり

| Phase | 優先度 | 所要時間 | 説明 |
|--------|--------|----------|------|
| Phase 1 | 🔴 高 | 4-6時間 | 基盤構築 |
| Phase 2 | 🔴 高 | 6-8時間 | 顔検出 |
| Phase 3 | 🔴 高 | 8-10時間 | UI制御 |
| Phase 4 | 🔴 高 | 10-12時間 | ワーピング |
| Phase 5 | 🟡 中 | 4-6時間 | 保存機能 |
| Phase 6 | 🟡 中 | 6-8時間 | エラー処理 |
| Phase 7 | 🟢 低 | 4-6時間 | UI改善 |
| Phase 8 | 🟢 低 | 4-6時間 | テスト |
| Phase 9 | 🟢 低 | 2-4時間 | ドキュメント |
| Phase 10 | 🔵 オプション | 10-20時間 | 拡張機能 |

**合計見積もり時間**: 58-86時間 （コア機能のみ: 38-52時間）

## 🎯 次のステップ

1. **Phase 1** から順番に実装を開始
2. 各Phase完了後に動作確認
3. 問題があれば前のPhaseに戻って修正
4. 最小限の機能でまず動作するものを完成させる
5. 段階的に機能を追加していく 

---

## 📋 Version 5.1.5 - ハイブリッドマッピングによる輪郭線残存問題の解決 (2025-07-04)

### 実装内容
1. **MovementMask型の追加**
   - 移動元領域の強度を記録するマスクデータ構造
   - `IndependentDeformationResult`に`movementMask`フィールドを追加

2. **generateMovementMask関数の実装**
   - 各制御点の移動量から影響範囲を計算
   - 移動元領域の強度マップを生成

3. **2パスレンダリング方式の実装**
   - **Phase 1**: 移動元領域のクリア処理
     - 周辺ピクセルの平均値で補完（簡易インペインティング）
     - 移動強度に応じたブレンド処理
   - **Phase 2**: 変形後の画像を上書き
     - 変形がある場合のみピクセルを更新

4. **getAverageOfSurroundingPixels関数の追加**
   - 指定半径内の周辺ピクセルから平均値を計算
   - 移動元領域の自然な補完を実現

### 技術的詳細
- **ファイル修正**: 
  - `src/features/image-warping/independentDeformation.ts`
  - `src/features/image-warping/adaptiveWarping.ts`
- **ビルド状態**: ✅ 成功
- **実装方式**: ハイブリッドマッピング（バックワード + フォワード要素）

### 期待される効果
- 目・口・鼻を移動した際の元位置の輪郭線が消える
- より自然な変形結果の実現
- 移動量に応じた適応的な処理
# 顔特徴点調整ツール

MediaPipeとStreamlitを使用した高精度な顔特徴点検出・調整システム

## 新しい実装について

元のコードに問題があったため、要件定義に基づいて1から新しいコードを作成しました。

### 作成したファイル

1. **`src/app_new.py`** - 基本版
   - シンプルなスライダーベースの調整機能
   - MediaPipeによる顔検出
   - 6つの主要特徴点の可視化

2. **`src/app_interactive.py`** - インタラクティブ版
   - streamlit-drawable-canvasを使用
   - ドラッグ&ドロップによる特徴点調整
   - リアルタイム座標変換

3. **`src/app_final.py`** - 完全版（推奨）
   - 信頼度評価機能
   - 解剖学的制約チェック
   - 高精度座標管理
   - 包括的エラーハンドリング

## 実装された機能

### ✅ 核心機能（完全実装）

- **顔特徴点検出**: MediaPipe Face Meshによる468個の特徴点検出
- **インタラクティブ調整**: ドラッグ&ドロップによる直感的な位置調整
- **リアルタイム可視化**: 調整結果の即座の反映
- **高精度座標変換**: 浮動小数点による誤差最小化

### ✅ 品質保証機能

- **信頼度評価**: 各特徴点の検出品質を色で表示
- **解剖学的制約**: 不自然な調整の自動警告
- **履歴管理**: Undo/Redo機能による操作の可逆性
- **エラーハンドリング**: 包括的な例外処理

### ✅ ユーザビリティ

- **直感的操作**: ドラッグ&ドロップによる調整
- **精密制御**: 移動検出閾値の調整可能
- **視覚フィードバック**: リアルタイムな結果表示
- **詳細情報**: 座標・信頼度・制約チェック結果

## セットアップと実行

### 1. 依存関係のインストール

```bash
# requirements.txtから依存関係をインストール
pip install -r requirements.txt
```

### 2. アプリケーションの実行

```bash
# 完全版を実行（推奨）
streamlit run src/app_final.py

# または基本版
streamlit run src/app_new.py

# またはインタラクティブ版
streamlit run src/app_interactive.py
```

## 使い方

### 基本的な流れ

1. **画像アップロード** - JPG、PNG、BMPファイルに対応
2. **顔検出** - MediaPipeが自動的に特徴点を検出
3. **特徴点調整** - 色付きの点をドラッグして位置を調整
4. **結果確認** - 調整後の画像と座標情報を確認

### 特徴点の識別

- 🟢 **鼻関連**: 鼻先（大きな緑）、鼻梁（小さな緑）
- 🔵 **小鼻関連**: 左小鼻（濃い青）、右小鼻（明るい青）
- 🔴 **目関連**: 左目（濃い赤）、右目（オレンジ）

### 調整機能

- **ドラッグ操作**: マウスで特徴点を直感的に移動
- **移動検出閾値**: 微小な動きを無視する設定
- **信頼度表示**: 検出品質を色で確認
- **制約チェック**: 解剖学的な妥当性を自動検証

## 技術仕様

### アーキテクチャ

- **フロントエンド**: Streamlit
- **画像処理**: OpenCV
- **顔検出**: MediaPipe Face Mesh
- **インタラクション**: streamlit-drawable-canvas
- **座標管理**: 高精度浮動小数点計算

### 対応する特徴点

| 特徴点 | MediaPipeインデックス | 説明 |
|--------|---------------------|------|
| 鼻先 | [1, 2] | 鼻の先端部分の平均 |
| 鼻梁 | [6, 9] | 鼻の橋部分の平均 |
| 左小鼻 | [131, 134, 126] | 左の小鼻の平均 |
| 右小鼻 | [102, 49, 48] | 右の小鼻の平均 |
| 左目中心 | [159, 158, 157, 173] | 左目周辺の平均 |
| 右目中心 | [386, 385, 384, 398] | 右目周辺の平均 |

### 品質管理

- **信頼度評価**: 点群の分散に基づく信頼度計算
- **座標精度**: 浮動小数点2桁精度での管理
- **制約検証**: 鼻の長さ・角度・小鼻間距離のチェック
- **履歴管理**: 最大20個の操作履歴保持

## 推奨する実行環境

- **Python**: 3.8以上
- **メモリ**: 2GB以上
- **ブラウザ**: Chrome、Firefox、Safari、Edge
- **画像**: 500×500ピクセル以上推奨

## トラブルシューティング

### よくある問題

1. **顔が検出されない**
   - 顔が正面を向いているか確認
   - 照明が適切か確認
   - 顔の一部が隠れていないか確認

2. **動作が重い**
   - 画像サイズを小さくする
   - ブラウザを再起動する
   - 他のタブを閉じる

3. **特徴点が正確でない**
   - 信頼度表示を有効にして品質を確認
   - 手動調整で位置を修正
   - より高品質な画像を使用

## 応用例

### 研究用途
- 認知心理学実験での顔画像処理
- 顔認識アルゴリズムの精度検証
- 特徴点データセットの手動調整

### 教育用途
- コンピュータビジョンの学習教材
- 画像処理技術の実践演習
- MediaPipe技術の理解促進

### 開発用途
- 顔認識アプリのプロトタイピング
- 前処理ツールとしての活用
- UI/UXデザインの参考実装

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

バグ報告や機能提案は歓迎します。GitHubのIssueまたはPull Requestでお知らせください。